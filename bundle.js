(()=>{"use strict";(()=>{let e=document.querySelector(".ad-form"),t=document.querySelector(".map__pins"),o=Math.floor(t.offsetWidth);const i=function(e,t){let o=e-.5+Math.random()*(t-e+1);return Math.round(o)};window.utill={CLICK_KEY:0,ENTER_KEY:13,ESC_KEY:27,form:e,mapContainer:t,index:void 0,offWidth:o,getRandomInteger:i,getRandomItem:function(e){const t=e.length-1;return e[i(0,t)]},StatusCode:{OK:200,NOT_FOUND:404,BAD_REQUEST:400,NOT_AUTORIZATION:401,NOT_AVILABLE:500}}})(),(()=>{let e=[];const t=function(e,t){let o=document.createElement(e);return o.classList.add(t),o},o=function(e){let o=t("button","map__pin"),i=t("img","map__pin--img");return i.setAttribute("alt",e.offer.title),i.setAttribute("src",e.author.avatar),i.setAttribute("width","40"),i.setAttribute("height","40"),i.setAttribute("data-index",window.utill.index),o.appendChild(i),o.setAttribute("style",`left:${e.location.x}px; top: ${e.location.y}px`),o.setAttribute("data-index",window.utill.index),o.tabIndex=window.utill.index,o};window.makePin={makeElement:t,makeOffer:function(t){const i=t.length>=5?5:t.length;for(let n=0;n<i;n++)window.utill.index=n,e[n]=o(t[n]),window.utill.mapContainer.appendChild(e[n])},items:e}})(),(()=>{let e=document.querySelector(".ad-form"),t=e.querySelectorAll("fieldset"),o=document.querySelector(".map"),i=window.utill.mapContainer.querySelector(".map__pin--main"),n=document.querySelector(".map__filters"),r=n.querySelectorAll("select"),a=n.querySelectorAll("fieldset");const d=function(){for(let e=0;e<t.length;e++)t[e].setAttribute("disabled","disabled");for(let e=0;e<r.length;e++)r[e].setAttribute("disabled","disabled");for(let e=0;e<a.length;e++)a[e].setAttribute("disabled","disabled");o.classList.add("map--faded"),e.classList.add("ad-form--disabled"),i.addEventListener("click",(function e(t){t.button===window.utill.CLICK_KEY&&(s(),i.removeEventListener("click",e))}))};d(),i.addEventListener("keydown",(function e(t){t.keyCode===window.utill.ENTER_KEY&&i.removeEventListener("keydown",e)}));const l=function(){window.load.removeClonePin(),window.makePin.makeOffer(window.DATA_OFFER)},s=function(){window.load.removeClonePin(),window.load.loadData(),o.classList.remove("map--faded"),e.classList.remove("ad-form--disabled");for(let e=0;e<t.length;e++)t[e].removeAttribute("disabled");for(let e=0;e<r.length;e++)r[e].removeAttribute("disabled");for(let e=0;e<a.length;e++)a[e].removeAttribute("disabled");setTimeout(l,1e3)};window.activeMap={adForm:e,disabledMap:d,mapPinMain:i}})(),(()=>{let e=window.utill.mapContainer.querySelector(".map__pin--main");e.addEventListener("mousedown",(function(t){t.preventDefault();let o=e.offsetTop,i=e.offsetLeft,n={x:t.clientX,y:t.clientY};const r=function(t){t.preventDefault();let r=n.x-t.clientX,a=n.y-t.clientY;n={x:t.clientX,y:t.clientY},o=Math.floor(e.offsetTop-a),i=Math.floor(e.offsetLeft-r),o<130||o>630||(e.style.top=o+"px"),e.style.left=i+"px",window.validateForm.getCoords({resultTop:o,resultLeft:i})},a=function(e){e.preventDefault(),window.validateForm.getCoords({resultTop:o,resultLeft:i}),window.utill.mapContainer.removeEventListener("mousemove",r),window.utill.mapContainer.removeEventListener("mouseup",a)};window.utill.mapContainer.addEventListener("mousemove",r),window.utill.mapContainer.addEventListener("mouseup",a)}))})(),(()=>{let e=document.querySelector(".ad-form__reset"),t=window.activeMap.adForm.querySelector("#title"),o=window.activeMap.adForm.querySelector("#address"),i=window.activeMap.adForm.querySelector("#room_number"),n=window.activeMap.adForm.querySelector("#capacity"),r=window.activeMap.adForm.querySelector("#type"),a=window.activeMap.adForm.querySelector("#price"),d=window.activeMap.adForm.querySelector("#timein"),l=window.activeMap.adForm.querySelector("#timeout"),s=Number(i.value),u=Number(n.value);d.addEventListener("change",(function(){l.value=d.value})),l.addEventListener("change",(function(){d.value=l.value})),r.addEventListener("input",function(e){switch(e.stopPropagation(),e.target.value){case"bungalow":a.setAttribute("placeholder","0");break;case"flat":a.setAttribute("placeholder","1000");break;case"house":a.setAttribute("placeholder","5000");break;case"palace":a.setAttribute("placeholder","10 000")}}.bind()),a.addEventListener("input",(function(e){e.stopPropagation(),e.target.value>=1e6&&a.setCustomValidity("Превышена максимальная стоимость!"),a.reportValidity()}));const c=function(){window.choisePhoto.imgAvatar.setAttribute("src","img/muffin-grey.svg"),o.setAttribute("value"," "),window.utill.form.reset(),window.activeMap.mapPinMain.setAttribute("style","left: 570px; top: 375px;"),window.load.removeClonePin(),window.cards.closeCards(),window.activeMap.disabledMap();let e=window.choisePhoto.containerImgFlat.querySelector("img");e&&e.remove()};e.addEventListener("click",(function(e){e.preventDefault(),c()})),t.addEventListener("input",(function(){let e=t.value.length;e<30?t.setCustomValidity("Необходимо "+(30-e)+" символов"):e>100?t.setCustomValidity("Удалите лишние "+(e-100)+" символы"):t.setCustomValidity(""),t.reportValidity()})),o.addEventListener("input",(function(){let e=o.value.length;e<5?o.setCustomValidity("Необходимо "+(5-e)+" символов"):e>30?o.setCustomValidity("Удалите лишние "+(e-30)+" символы"):o.setCustomValidity(""),o.reportValidity()})),i.addEventListener("input",(function(e){e.stopPropagation(),s=Number(e.target.value),f(),i.reportValidity()})),n.addEventListener("input",(function(e){e.stopPropagation(),u=Number(e.target.value),f(),n.reportValidity()}));const f=function(){i.setCustomValidity(""),s<u&&i.setCustomValidity("Колличества комнат не совпадает с колличеством гостей. Измените выбор")};window.validateForm={getCoords:function(e){o.setAttribute("value",`${e.resultLeft}px , ${e.resultTop}px`)},clearForm:c}})(),(()=>{let e,t,o;const i={flat:"Квартира",house:"Дом",bungalow:"Бунгало",palace:"Дворец"};window.utill.mapContainer.addEventListener("click",(function(e){"map__pin"===e.target.className||"map__pin--img"===e.target.className?(window.utill.index=Number(e.target.getAttribute("data-index")),n(),window.sortOffers&&a(window.sortOffers)):"popup__close"===e.target.className&&(t=e.target.closest(".popup"),t.remove())})),window.utill.mapContainer.addEventListener("keydown",(function(e){e.keyCode===window.utill.ESC_KEY&&n()}));const n=function(){document.querySelectorAll(".popup").forEach((e=>e.remove()))},r=function(e,t){o=t[window.utill.index],e.querySelector("H3").textContent=o.offer.title,e.querySelector(".popup__text--address").textContent=o.offer.address,e.querySelector(".popup__text--price").textContent=o.offer.price+" ₽/ночь",e.querySelector(".popup__type").textContent=i[o.offer.type],e.querySelector(".popup__text--capacity").textContent=o.offer.rooms+" комнаты для "+o.offer.guests+" гостей",e.querySelector(".popup__text--time").textContent="Заезд после "+o.offer.checkin+" , выезд до "+o.offer.checkout,e.querySelector(".popup__description").textContent=o.offer.description,e.querySelector(".popup__avatar").setAttribute("src",o.author.avatar),e.querySelector(".popup__features").textContent="";for(let t=0;t<o.offer.features.length;t++){let i=o.offer.features[t],n=window.makePin.makeElement("li","popup__feature");n.setAttribute("width","20"),n.setAttribute("height","20"),n.classList.add("popup__feature--"+i),e.querySelector(".popup__features").appendChild(n)}e.querySelector(".popup__photo").remove();for(let t=0;t<o.offer.photos.length;t++){let i,n=window.makePin.makeElement("img","popup__photo");i=o.offer.photos[t],n.setAttribute("src",i),n.setAttribute("width","45"),n.setAttribute("height","40"),e.querySelector(".popup__photos").appendChild(n)}return e},a=function(t){let o=document.querySelector("#card").content.querySelector("article").cloneNode(!0);e=r(o,t),window.utill.mapContainer.appendChild(e)};window.cards={getClone:a,addInfo:r,closeCards:n}})(),(()=>{let e,t=new XMLHttpRequest,o="#success",i="#error";window.utill.form.addEventListener("submit",(function(e){e.preventDefault();let t=new FormData(window.utill.form),r=new XMLHttpRequest;r.responseType="json",r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.send(t),r.addEventListener("load",(function(){switch(r.status){case window.utill.StatusCode.OK:n(o,"div");break;case window.utill.StatusCode.BAD_REQUEST:case window.utill.StatusCode.NOT_AVILABLE:n(i,"div")}})),window.activeMap.disabledMap(),window.cards.closeCards(),window.validateForm.clearForm()}));const n=function(t,n){let r=document.querySelector(t).content.querySelector(n);e=r.cloneNode(!0),window.utill.form.appendChild(e),t===i?d(i):t===o&&d(o)},r=function(e){e.remove()},a=function(){document.addEventListener("keydown",(function t(o){o.keyCode!==window.utill.ESC_KEY&&o.keyCode!==window.utill.ENTER_KEY||(o.preventDefault(),r(e),window.validateForm.clearForm(),document.removeEventListener("keydown",t))})),document.addEventListener("click",(function t(o){o.preventDefault(),r(e),window.validateForm.clearForm(),document.removeEventListener("click",t)}))},d=function(e){a(),e===i?document.querySelector(".error__button").addEventListener("click",(function(e){e.preventDefault(),a()})):e===o&&a(),window.load.removeClonePin()};window.load={removeClonePin:function(){window.makePin.items.forEach((e=>e.remove()))},loadData:function(){t.addEventListener("load",(function(){let e;switch(t.status){case window.utill.StatusCode.OK:window.DATA_OFFER=JSON.parse(t.responseText),window.sortOffers=window.DATA_OFFER;break;case window.utill.StatusCode.BAD_REQUEST:e="Неверный запрос";break;case window.utill.StatusCode.NOT_AUTORIZATION:e="Пользователь не авторизован";break;case window.utill.StatusCode.NOT_FOUND:e="Ничего не найдено";break;default:e="Cтатус ответа: : "+t.status+" "+t.statusText}})),t.addEventListener("errorMessage",(function(){})),t.addEventListener("timeout",(function(){t.timeout})),t.timeout=5e3,t.open("GET","https://21.javascript.pages.academy/keksobooking/data"),t.send()}}})(),(()=>{let e,t,o,i,n=document.querySelector(".map__filters"),r={isWifi:!1,isDish:!1,isWasher:!1,isElevator:!1,isCondicioner:!1,isParking:!1};n.addEventListener("change",function(e){let t=!1;return function(o){t&&clearTimeout(t),t=setTimeout(e.bind(null,o),1e3)}}((function(n){switch(n.preventDefault(),n.stopPropagation(),n.target.id){case"housing-type":o=n.target.value;break;case"housing-price":i=n.target.value;break;case"housing-rooms":t=Number(n.target.value);break;case"housing-guests":e=Number(n.target.value);break;case"filter-wifi":r.isWifi=n.target.checked;break;case"filter-dishwasher":r.isDish=n.target.checked;break;case"filter-washer":r.isWasher=n.target.checked;break;case"filter-elevator":r.isElevator=n.target.checked;break;case"filter-conditioner":r.isCondicionercioner=n.target.checked;break;case"filter-parking":r.isParking=n.target.checked}window.sortOffers=[],window.sortOffers=window.DATA_OFFER.filter((n=>function(n){let a=1;var d;return o&&"any"!==o&&(a=n.offer.type===o?2*a:0),t&&"any"!==t&&(a=n.offer.rooms===Number(t)?2*a:0),e&&"any"!==e&&(a=n.offer.guests===e?2*a:0),i&&"any"!==i&&(a=((d=n.offer.price)<1e4?"low":d>=1e4&&d<=5e4?"middle":d>5e4?"high":void 0)===i?2*a:0),r.isWifi&&(a=n.offer.features.includes("wifi")?2*a:0),r.isDish&&(a=n.offer.features.includes("dishwasher")?2*a:0),r.isWasher&&(a=n.offer.features.includes("washer")?2*a:0),r.isElevator&&(a=n.offer.features.includes("elevator")?2*a:0),r.isCondicionercioner&&(a=n.offer.features.includes("conditioner")?2*a:0),r.isParking&&(a=n.offer.features.includes("parking")?2*a:0),a}(n)>0)),window.load.removeClonePin(),window.cards.closeCards(),window.makePin.makeOffer(window.sortOffers),window.cards.getClone(window.sortOffers),window.cards.closeCards()})))})(),(()=>{const e=["gif","jpg","jpeg","png"];let t,o=document.querySelector(".ad-form-header__preview").querySelector("img"),i=document.querySelector(".ad-form-header__input"),n=document.querySelector(".ad-form__input"),r=document.querySelector(".ad-form__photo");i.addEventListener("change",(function(){let t=i.files[0],n=t.name.toLowerCase();if(e.some((function(e){return n.endsWith(e)}))){let e=new FileReader;e.addEventListener("load",(function(){o.src=e.result})),e.readAsDataURL(t)}})),n.addEventListener("change",(function(){t=window.makePin.makeElement("img","undefied"),t.setAttribute("width",70),t.setAttribute("height",70),r.appendChild(t);let o=n.files[0],i=o.name.toLowerCase();if(e.some((function(e){return i.endsWith(e)}))){let e=new FileReader;e.addEventListener("load",(function(){t.src=e.result})),e.readAsDataURL(o)}})),window.choisePhoto={imgAvatar:o,containerImgFlat:r}})()})();