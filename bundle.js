(()=>{"use strict";(()=>{let e=document.querySelector(".ad-form"),t=document.querySelector(".map__pins"),o=Math.floor(t.offsetWidth);const n=function(e,t){let o=e-.5+Math.random()*(t-e+1);return Math.round(o)};window.utill={CLICK_KEY:0,ENTER_KEY:13,ESC_KEY:27,form:e,mapContainer:t,index:void 0,offWidth:o,getRandomInteger:n,getRandomItem:function(e){const t=e.length-1;return e[n(0,t)]},StatusCode:{OK:200,NOT_FOUND:404,BAD_REQUEST:400,NOT_AUTORIZATION:401,NOT_AVILABLE:500}}})(),(()=>{let e=[];const t=function(e,t){let o=document.createElement(e);return o.classList.add(t),o},o=function(e){let o=t("button","map__pin"),n=t("img","map__pin--img");return n.setAttribute("alt",e.offer.title),n.setAttribute("src",e.author.avatar),n.setAttribute("width","40"),n.setAttribute("height","40"),n.setAttribute("data-index",window.utill.index),o.appendChild(n),o.setAttribute("style",`left:${e.location.x}px; top: ${e.location.y}px`),o.setAttribute("data-index",window.utill.index),o.tabIndex=window.utill.index,o};window.makePin={makeElement:t,makeOffer:function(t){const n=t.length>=5?5:t.length;for(let i=0;i<n;i++)window.utill.index=i,e[i]=o(t[i]),window.utill.mapContainer.appendChild(e[i])},items:e}})(),(()=>{let e=document.querySelector(".ad-form"),t=e.querySelectorAll("fieldset"),o=document.querySelector(".map"),n=window.utill.mapContainer.querySelector(".map__pin--main"),i=document.querySelector(".map__filters"),r=i.querySelectorAll("select"),a=i.querySelectorAll("fieldset");const d=function(){for(let e=0;e<t.length;e++)t[e].setAttribute("disabled","disabled");for(let e=0;e<r.length;e++)r[e].setAttribute("disabled","disabled");for(let e=0;e<a.length;e++)a[e].setAttribute("disabled","disabled");o.classList.add("map--faded"),e.classList.add("ad-form--disabled"),n.addEventListener("click",(function e(t){t.button===window.utill.CLICK_KEY&&(l(),n.removeEventListener("click",e))}))};d(),n.addEventListener("keydown",(function e(t){t.keyCode===window.utill.ENTER_KEY&&n.removeEventListener("keydown",e)}));const l=function(){o.classList.remove("map--faded"),e.classList.remove("ad-form--disabled");for(let e=0;e<t.length;e++)t[e].removeAttribute("disabled");for(let e=0;e<r.length;e++)r[e].removeAttribute("disabled");for(let e=0;e<a.length;e++)a[e].removeAttribute("disabled");window.makePin.makeOffer(window.DATA_OFFER)};window.activeMap={adForm:e,disabledMap:d}})(),(()=>{let e=window.utill.mapContainer.querySelector(".map__pin--main");e.addEventListener("mousedown",(function(t){t.preventDefault();let o=e.offsetTop,n=e.offsetLeft,i={x:t.clientX,y:t.clientY};const r=function(t){t.preventDefault();let r=i.x-t.clientX,a=i.y-t.clientY;i={x:t.clientX,y:t.clientY},o=Math.floor(e.offsetTop-a),n=Math.floor(e.offsetLeft-r),o<130||o>630||(e.style.top=o+"px"),e.style.left=n+"px",window.validateForm.setAdress({resultTop:o,resultLeft:n})},a=function(e){e.preventDefault(),window.validateForm.setAdress({resultTop:o,resultLeft:n}),window.utill.mapContainer.removeEventListener("mousemove",r),window.utill.mapContainer.removeEventListener("mouseup",a)};window.utill.mapContainer.addEventListener("mousemove",r),window.utill.mapContainer.addEventListener("mouseup",a)}))})(),function(){let e=document.querySelector(".ad-form__reset"),t=window.activeMap.adForm.querySelector("#title"),o=window.activeMap.adForm.querySelector("#address"),n=window.activeMap.adForm.querySelector("#room_number"),i=window.activeMap.adForm.querySelector("#capacity"),r=window.activeMap.adForm.querySelector("#type"),a=window.activeMap.adForm.querySelector("#price"),d=window.activeMap.adForm.querySelector("#timein"),l=window.activeMap.adForm.querySelector("#timeout"),s=Number(n.value),u=Number(i.value);d.addEventListener("change",(function(){let e=d.value;l.value=e})),l.addEventListener("change",(function(){let e=l.value;d.value=e})),r.addEventListener("input",function(e){switch(e.stopPropagation(),e.target.value){case"bungalow":a.setAttribute("placeholder","0");break;case"flat":a.setAttribute("placeholder","1000");break;case"house":a.setAttribute("placeholder","5000");break;case"palace":a.setAttribute("placeholder","10 000")}}.bind()),a.addEventListener("input",(function(e){e.stopPropagation(),e.target.value>=1e6&&a.setCustomValidity("Превышена максимальная стоимость!"),a.reportValidity()}));const c=function(){window.utill.form.reset()};e.addEventListener("click",(function(e){e.preventDefault(),c()})),t.addEventListener("input",(function(){let e=t.value.length;e<30?t.setCustomValidity("Необходимо "+(30-e)+" символов"):e>100?t.setCustomValidity("Удалите лишние "+(e-100)+" символы"):t.setCustomValidity(""),t.reportValidity()})),o.addEventListener("input",(function(){let e=o.value.length;e<5?o.setCustomValidity("Необходимо "+(5-e)+" символов"):e>30?o.setCustomValidity("Удалите лишние "+(e-30)+" символы"):o.setCustomValidity(""),o.reportValidity()})),n.addEventListener("input",(function(e){e.stopPropagation(),s=Number(e.target.value),f(),n.reportValidity()})),i.addEventListener("input",(function(e){e.stopPropagation(),u=Number(e.target.value),f(),i.reportValidity()}));const f=function(){n.setCustomValidity(""),s<u&&n.setCustomValidity("Колличества комнат не совпадает с колличеством гостей. Измените выбор")};window.validateForm={setAdress:function(e){o.setAttribute("value",`${e.resultLeft}px расстояние до острого конца по горизонтали, ${e.resultTop}px расстояние до острого конца по вертикали`)},clearForm:c}}(),(()=>{let e,t,o;const n={flat:"Квартира",house:"Дом",bungalow:"Бунгало",palace:"Дворец"};window.utill.mapContainer.addEventListener("click",(function(e){"map__pin"===e.target.className||"map__pin--img"===e.target.className?(window.utill.index=Number(e.target.getAttribute("data-index")),i(),window.sortOffers&&a(window.sortOffers)):"popup__close"===e.target.className&&(t=e.target.closest(".popup"),t.remove())})),window.utill.mapContainer.addEventListener("keydown",(function(e){e.keyCode===window.utill.ESC_KEY&&i()}));const i=function(){document.querySelectorAll(".popup").forEach((e=>e.remove()))},r=function(e,t){o=t[window.utill.index],e.querySelector("H3").textContent=o.offer.title,e.querySelector(".popup__text--address").textContent=o.offer.address,e.querySelector(".popup__text--price").textContent=o.offer.price+" ₽/ночь",e.querySelector(".popup__type").textContent=n[o.offer.type],e.querySelector(".popup__text--capacity").textContent=o.offer.rooms+" комнаты для "+o.offer.guests+" гостей",e.querySelector(".popup__text--time").textContent="Заезд после "+o.offer.checkin+" , выезд до "+o.offer.checkout,e.querySelector(".popup__description").textContent=o.offer.description,e.querySelector(".popup__avatar").setAttribute("src",o.author.avatar),e.querySelector(".popup__features").textContent="";for(let t=0;t<o.offer.features.length;t++){let n=o.offer.features[t],i=window.makePin.makeElement("li","popup__feature");i.setAttribute("width","20"),i.setAttribute("height","20"),i.classList.add("popup__feature--"+n),e.querySelector(".popup__features").appendChild(i)}e.querySelector(".popup__photo").remove();for(let t=0;t<o.offer.photos.length;t++){let n,i=window.makePin.makeElement("img","popup__photo");n=o.offer.photos[t],i.setAttribute("src",n),i.setAttribute("width","45"),i.setAttribute("height","40"),e.querySelector(".popup__photos").appendChild(i)}return e},a=function(t){let o=document.querySelector("#card").content.querySelector("article").cloneNode(!0);e=r(o,t),window.utill.mapContainer.appendChild(e)};window.cards={getClone:a,addInfo:r,flatElement:o,closeCards:i}})(),(()=>{const e=function(e){console.log(e)};let t=new XMLHttpRequest;t.addEventListener("load",(function(){let o;switch(t.status){case window.utill.StatusCode.OK:window.DATA_OFFER=JSON.parse(t.responseText),window.sortOffers=window.DATA_OFFER;break;case window.utill.StatusCode.BAD_REQUEST:o="Неверный запрос";break;case window.utill.StatusCode.NOT_AUTORIZATION:o="Пользователь не авторизован";break;case window.utill.StatusCode.NOT_FOUND:o="Ничего не найдено";break;default:o="Cтатус ответа: : "+t.status+" "+t.statusText}o&&e(o)})),t.addEventListener("error",(function(){e("Произошла ошибка соединения")})),t.addEventListener("timeout",(function(){e("Запрос не успел выполниться за "+t.timeout+"мс")})),t.timeout=5e3,t.open("GET","https://21.javascript.pages.academy/keksobooking/data"),t.send()})(),(()=>{let e,t="#success",o="#error";window.utill.form.addEventListener("submit",(function(e){e.preventDefault();let i=new FormData(window.utill.form),r=new XMLHttpRequest;r.responseType="json",r.open("POST","https://21.javascript.pages.academy/keksobooking"),r.send(i),r.addEventListener("load",(function(){switch(r.status){case window.utill.StatusCode.OK:n(t,"div");break;case window.utill.StatusCode.BAD_REQUEST:case window.utill.StatusCode.NOT_AVILABLE:n(o,"div")}})),window.activeMap.disabledMap(),window.upload.removeClonePin(),window.cards.closeCards()}));const n=function(n,i){let a=document.querySelector(n).content.querySelector(i);e=a.cloneNode(!0),window.utill.form.appendChild(e),n===o?r(o):n===t&&r(t)},i=function(){document.addEventListener("keydown",(function(t){t.keyCode!==window.utill.ESC_KEY&&t.keyCode!==window.utill.ENTER_KEY||(t.preventDefault(),a(e))})),document.addEventListener("click",(function(t){t.preventDefault(),a(e)}))},r=function(n){if(n===o){let t=document.querySelector(".error__button");t.addEventListener("click",(function t(o){o.preventDefault(),t(e)})),i(),t.removeEventListener("click",a)}else n===t&&i();window.upload.removeClonePin(),window.validateForm.clearForm()},a=function(e){e.remove()};window.upload={removeClonePin:function(){window.makePin.items.forEach((e=>e.remove()))}}})(),(()=>{let e,t,o,n,i=document.querySelector(".map__filters"),r={isWifi:!1,isDish:!1,isWasher:!1,isElevator:!1,isCondicioner:!1,isParking:!1};i.addEventListener("change",function(e){let t=!1;return function(o){t&&clearTimeout(t),t=setTimeout(e.bind(this,o),1e3)}}((function(i){switch(i.preventDefault(),i.stopPropagation(),i.target.id){case"housing-type":o=i.target.value;break;case"housing-price":n=i.target.value;break;case"housing-rooms":t=Number(i.target.value);break;case"housing-guests":e=Number(i.target.value);break;case"filter-wifi":r.isWifi=i.target.checked;break;case"filter-dishwasher":r.isDish=i.target.checked;break;case"filter-washer":r.isWasher=i.target.checked;break;case"filter-elevator":r.isElevator=i.target.checked;break;case"filter-conditioner":r.isCondicionercioner=i.target.checked;break;case"filter-parking":r.isParking=i.target.checked}window.sortOffers=[],window.sortOffers=window.DATA_OFFER.filter((i=>function(i){let a=1;var d;return o&&"any"!==o&&(a=i.offer.type===o?2*a:0),t&&"any"!==t&&(a=i.offer.rooms===Number(t)?2*a:0),e&&"any"!==e&&(a=i.offer.guests===e?2*a:0),n&&"any"!==n&&(a=((d=i.offer.price)<1e4?"low":d>=1e4&&d<=5e4?"middle":d>5e4?"high":void 0)===n?2*a:0),r.isWifi&&(a=i.offer.features.includes("wifi")?2*a:0),r.isDish&&(a=i.offer.features.includes("dishwasher")?2*a:0),r.isWasher&&(a=i.offer.features.includes("washer")?2*a:0),r.isElevator&&(a=i.offer.features.includes("elevator")?2*a:0),r.isCondicionercioner&&(a=i.offer.features.includes("conditioner")?2*a:0),r.isParking&&(a=i.offer.features.includes("parking")?2*a:0),a}(i)>0)),function(){try{window.upload.removeClonePin(),window.cards.closeCards(),window.makePin.makeOffer(window.sortOffers),window.cards.getClone(window.sortOffers),window.cards.closeCards()}catch(e){}}()})))})(),(()=>{const e=["gif","jpg","jpeg","png"];let t=document.querySelector(".ad-form-header__preview").querySelector("img"),o=document.querySelector(".ad-form-header__input"),n=document.querySelector(".ad-form__input"),i=document.querySelector(".ad-form__photo");o.addEventListener("change",(function(){let n=o.files[0],i=n.name.toLowerCase();if(e.some((function(e){return i.endsWith(e)}))){let e=new FileReader;e.addEventListener("load",(function(){t.src=e.result})),e.readAsDataURL(n)}})),n.addEventListener("change",(function(){let t=window.makePin.makeElement("img","undefied");t.setAttribute("width",70),t.setAttribute("height",70),i.appendChild(t);let o=n.files[0],r=o.name.toLowerCase();if(e.some((function(e){return r.endsWith(e)}))){let e=new FileReader;e.addEventListener("load",(function(){t.src=e.result})),e.readAsDataURL(o)}}))})()})();